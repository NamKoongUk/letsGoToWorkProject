<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Mail">
	<resultMap type="com.kh.lgtw.mail.model.vo.Mail" id="resultMailSet">
		<id property="mailNo" column="Mail_No"/>
		<result property="mTitle" column="MTITLE"/>
		<result property="mContent" column="MCONTENT"/>
		<result property="sendMail" column="SEND_MAIL"/>
		<result property="reciveMail" column="RECIVE_MAIL"/>
		<result property="dStatus" column="DSTATUS"/>
		<result property="sendDate" column="SEND_DATE"/>
		<result property="rStatus" column="RSTATUS"/>
		<result property="mailType" column="MAIL_TYPE"/>
		<result property="mSize" column="MSIZE"/>
		<result property="reservationCheck" column="RESERVATION_CHECK"/>
		<result property="reservationDate" column="RESERVATION_DATE"/>
		<result property="reservationTime" column="RESERVATION_TIME"/>
	</resultMap>
	
	<resultMap type="com.kh.lgtw.mail.model.vo.Absence" id="resultAbsenceSet">
		<id property="aNo" column="ANO"/>
		<result property="startDate" column="START_DATE"/>
		<result property="endDate" column="END_DATE"/>
		<result property="aKind" column="AKIND"/>
		<result property="content" column="CONTENT"/>
		<result property="dStatus" column="DSTATUS"/>
		<result property="empNo" column="EMPNO"/>
	</resultMap>
	
	<!-- 쿼리문 -->
	<!-- 페이징-리스트 갯수 조회 -->
	<select id="getMailListCount" resultType="_int">
		SELECT COUNT(*)
		FROM MAIL
		WHERE DSTATUS = 'N' 
	</select>
	
	<!-- 메일 리스트 조회 -->
	<select id="selectMailList" parameterType="PageInfo" resultMap="resultMailSet">
		SELECT * 
		FROM MAIL 
		WHERE DSTATUS = 'N'
		ORDER BY MAIL_NO DESC
	</select>
	
	<!-- 읽음 상태 수정 -->
	<update id="updateReadStatus">
		UPDATE MAIL
		SET RSTATUS = 'Y'
		WHERE MAIL_NO = #{ mailNo }
	</update>
	
	<!-- 삭제 상태 수정 -->
	<update id="updateDeleteStatus">
		UPDATE MAIL
		SET DSTATUS = 'Y'
		WHERE MAIL_NO = #{ mailNo }
	</update>
	
	<!-- 메일 상세 페이지 조회 -->
	<select id="selectMailDetail" parameterType="int" resultMap="resultMailSet">
		SELECT *
		FROM MAIL 
		WHERE DSTATUS = 'N'
		AND MAIL_NO = #{ mailNo }
	</select>
	
	<!-- 부재중 정보 추가 -->
	<insert id="insertAbsenceMail" parameterType="Absence">
		INSERT INTO ABSENCE(ANO, START_DATE, END_DATE, AKIND, CONTENT, DSTATUS, EMPNO)
		VALUES (SEQ_ANO.NEXTVAL, #{ startDate }, #{ endDate }, #{ aKind }, #{ content }, 'N', #{ empNo })
	</insert>
	
	<!-- 부재중 조회 -->
	<select id="selectAbsenceList" parameterType="int" resultMap="resultAbsenceSet">
		SELECT * 
		FROM ABSENCE
		WHERE DSTATUS = 'N'
		AND EMPNO = #{ empNo }
		ORDER BY START_DATE DESC
	</select>
	
	<!-- 메일 보내기 DB저장 -->
	<insert id="sendMail" parameterType="Mail">
		INSERT INTO MAIL(MAIL_NO, MTITLE, MCONTENT, SEND_MAIL, RECIVE_MAIL, MAIL_TYPE, MSIZE)
		VALUES (SEQ_MAIL_NO.NEXTVAL, #{ mTitle }, #{ mContent }, #{ sendMail }, #{ reciveMail }, '보낸 메일', #{ mSize })
	</insert>
	
	<!-- 검색 메일 조회 -->
	<select id="searchMailList" resultMap="resultMailSet">
		SELECT *
		FROM MAIL
		WHERE (SEND_MAIL = #{ empEmail }
		OR RECIVE_MAIL = #{ empEmail })
		<choose>
			<when test="listType == 'receive'">AND MAIL_TYPE = '받은메일'</when>
			<when test="listType == 'send'"> AND MAIL_TYPE = '보낸메일'</when>
			<when test="listType == 'outbox'"> AND MAIL_TYPE = '임시보관'</when>
			<when test="listType == 'trash'"> AND DSTATUS = 'Y'</when>
			<when test="listType != 'trash'">AND DSTATUS = 'N'</when>
		</choose>
		<choose>
			<when test="sMail != null">
				<foreach item="mail" index="index" collection="#{ sMail }">
					AND (RECIVE_MAIL = #{ mail.value } OR SEND_MAIL = #{ mail.value })
				  </foreach>
			</when>
			<when test="sTitle != null">AND MTITLE LIKE '%' || #{ sTitle } || '%'</when>
			<when test="sContent != null">AND MCONTENT LIKE '%' || #{ sContent } || '%' </when>
			<when test="sMail != null">AND (RECIVE_MAIL = #{ sMail } OR SEND_MAIL = #{ sMail })</when>
		</choose>
		ORDER BY MAIL_NO DESC
	</select>
	
	<!-- 검색 메일 조회 - 해쉬맵으로 -->
	<select id="searchList" resultMap="resultMailSet">
		SELECT *FROM MAIL
		WHERE (SEND_MAIL = #{ empMail }
		OR RECIVE_MAIL = #{ empMail })
		<choose>
			<when test="listType == 'receive'">AND MAIL_TYPE = '받은메일'</when>
			<when test="listType == 'send'"> AND MAIL_TYPE = '보낸메일'</when>
			<when test="listType == 'outbox'"> AND MAIL_TYPE = '임시보관'</when>
			<when test="listType == 'trash'"> AND DSTATUS = 'Y'</when>
			<when test="listType != 'trash'">AND DSTATUS = 'N'</when>
		</choose>
		<choose>
			<when test="sName != null">AND (RECIVE_MAIL = #{ nameMail } OR SEND_MAIL = #{ nameMail })</when>
			<when test="sTitle != null">AND MTITLE LIKE '%' || #{ sTitle } || '%'</when>
			<when test="sContent != null">AND MCONTENT LIKE '%' || #{ sContent } || '%' </when>
			<when test="sMail != null">AND (RECIVE_MAIL = #{ sMail } OR SEND_MAIL = #{ sMail })</when>
		</choose>
		ORDER BY MAIL_NO DESC
	</select>
</mapper>


<!-- <select id="searchMailList" resultMap="resultMailSet">
		SELECT *FROM MAIL 
		WHERE (SEND_MAIL = #{ empEmail }
		OR RECIVE_MAIL = #{ empEmail })
		<choose>
			<when test="listType == 'all'"></when>
			<when test="listType == 'receive'">AND MAIL_TYPE = '받은메일'</when>
			<when test="listType == 'send'"> AND MAIL_TYPE = '보낸메일'</when>
			<when test="listType == 'outbox'"> AND MAIL_TYPE = '임시보관'</when>
			<when test="listType == 'trash'"> AND DSTATUS = 'Y'</when>
			<when test="listType != 'trash'">AND DSTATUS = 'N'</when>
		</choose>
		<choose>
			<when test="sName != null">
			메일로 검색 vs 사원 이름으로 검색하기
			</when>
			<when test="sTitle != null">AND MTITLE LIKE '%' || #{ sTitle } || '%'</when>
			<when test="sContent != null">AND CONTENT LIKE '%' || #{ sContent } || '%' </when>
			<when test="sWriter != null">
			작성자 검색 -> 작성한메일 검색?
			</when>
		</choose>
		ORDER BY MAIL_NO DESC
	</select> -->


















